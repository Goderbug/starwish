import React from 'react';
import { ArrowLeft, LogIn, LogOut, User } from 'lucide-react';
import { useAuth } from '../hooks/useAuth';
import { useLanguage } from '../contexts/LanguageContext';
import { signOut } from '../lib/supabase';
import LanguageSwitcher from './LanguageSwitcher';

interface HeaderProps {
  showBackButton?: boolean;
  onBack?: () => void;
  onAuthRequired?: () => void;
}

const Header: React.FC<HeaderProps> = ({ 
  showBackButton, 
  onBack, 
  onAuthRequired 
}) => {
  const { user, loading } = useAuth();
  const { t } = useLanguage();

  const handleSignOut = async () => {
    console.log('🔄 Header: 开始登出');
    
    try {
      await signOut();
      console.log('✅ Header: 登出完成');
    } catch (error) {
      console.error('❌ Header: 登出错误:', error);
    }
  };

  const handleSignIn = () => {
    console.log('🔐 Header: 触发登录');
    if (onAuthRequired) {
      onAuthRequired();
    }
  };

  return (
    <header className="fixed top-0 left-0 right-0 z-50 bg-gradient-to-b from-black/20 to-transparent backdrop-blur-sm">
      <div className="flex items-center justify-between p-4 sm:p-6">
        {/* Left side - Logo (只在首页显示) 和 Back button */}
        <div className="flex items-center space-x-4">
          {/* Logo - 只在非back button页面显示，避免挤压 */}
          {!showBackButton && (
            <div className="flex items-center">
              <svg 
                width="157" 
                height="60" 
                viewBox="0 0 157 60" 
                fill="none" 
                xmlns="http://www.w3.org/2000/svg"
                className="h-[48px] sm:h-[60px] w-auto transition-all duration-300"
              >
                <path d="M18.1731 44.1006H3.62796V40.4726H1.81953V36.8336H3.62796V38.6531H5.44749V40.4726H7.26701V42.2922H16.3536V40.4726H18.1731V34.1043H16.3536V32.2959H12.7256V30.4763H9.08654V28.6568H5.44749V26.8373H3.62796V25.0177H1.81953V18.6605H3.62796V16.841H5.44749V15.0214H18.1731V16.841H19.9926V20.48H18.1731V18.6605H16.3536V16.841H7.26701V18.6605H5.44749V23.1982H7.26701V25.0177H10.9061V26.8373H14.534V28.6568H18.1731V30.4763H19.9926V32.2959H21.8121V40.4726H19.9926V42.2922H18.1731V44.1006ZM34.5599 44.1006H29.1013V42.2922H27.2818V25.9275H25.4734V24.108H27.2818V22.2885H29.1013V20.48H30.9209V24.108H36.3794V25.9275H30.9209V42.2922H34.5599V44.1006ZM36.3794 42.2922H34.5599V40.4726H36.3794V42.2922ZM57.2707 44.1006H53.6317V42.2922H50.0037V40.4726H51.8121V33.1945H50.0037V31.3861H51.8121V27.747H50.0037V25.9275H44.5451V27.747H42.7256V29.5666H39.0976V27.747H40.9061V25.9275H42.7256V24.108H51.8121V25.9275H53.6317V27.747H55.4512V42.2922H57.2707V44.1006ZM50.0037 35.014H44.5451V33.1945H50.0037V35.014ZM50.0037 44.1006H42.7256V42.2922H40.9061V40.4726H39.0976V36.8336H40.9061V35.014H44.5451V36.8336H42.7256V40.4726H44.5451V42.2922H50.0037V44.1006ZM67.267 44.1006H60V42.2922H61.8084V27.747H60V25.9275H61.8084V24.108H63.628V22.2885H65.4475V25.9275H67.267V27.747H65.4475V42.2922H67.267V44.1006ZM74.534 27.747H70.9061V25.9275H67.267V24.108H74.534V27.747Z" fill="white"/>
                <path d="M120.542 29.2762C121.065 29.2762 121.44 29.3898 121.667 29.617C121.917 29.8443 122.042 30.1396 122.042 30.5032C122.042 31.094 121.86 31.6166 121.497 32.071C121.156 32.5254 120.611 32.764 119.861 32.7867C118.066 32.8095 116.453 32.6731 115.021 32.3778C113.431 35.7633 111.511 38.5808 109.261 40.8303C107.034 43.057 104.83 44.1704 102.649 44.1704C100.649 44.1704 99.1498 43.1138 98.1501 41.0007C97.1503 38.8649 96.5823 36.0133 96.4459 32.4459C95.0826 36.3995 93.5375 39.342 91.8107 41.2734C90.1065 43.2047 88.2888 44.1704 86.3574 44.1704C84.1761 44.1704 82.5288 42.8185 81.4154 40.1146C80.302 37.3879 79.7453 33.7297 79.7453 29.1399C79.7453 25.7998 80.0407 22.1302 80.6315 18.1311C80.7905 16.995 81.0746 16.2111 81.4836 15.7794C81.9153 15.325 82.5856 15.0978 83.4944 15.0978C84.1761 15.0978 84.6987 15.2454 85.0623 15.5408C85.4485 15.8362 85.6417 16.3815 85.6417 17.1768C85.6417 17.3359 85.6189 17.6426 85.5735 18.097C84.8918 22.755 84.551 26.72 84.551 29.992C84.551 33.0367 84.8123 35.3884 85.3349 37.0471C85.8575 38.7058 86.5619 39.5351 87.4481 39.5351C88.2433 39.5351 89.1976 38.7058 90.311 37.0471C91.4471 35.3657 92.5718 32.889 93.6852 29.617C94.7986 26.3224 95.7415 22.4028 96.5141 17.8585C96.6959 16.8133 97.0253 16.0975 97.5025 15.7112C98.0024 15.3022 98.6727 15.0978 99.5134 15.0978C100.218 15.0978 100.729 15.2568 101.047 15.5749C101.388 15.8703 101.558 16.3247 101.558 16.9382C101.558 17.3018 101.536 17.5858 101.49 17.7903C100.854 21.494 100.536 25.1976 100.536 28.9013C100.536 31.4234 100.615 33.4343 100.774 34.934C100.956 36.4336 101.286 37.5811 101.763 38.3763C102.263 39.1489 102.978 39.5351 103.91 39.5351C105.001 39.5351 106.216 38.7172 107.557 37.0812C108.898 35.4225 110.125 33.3662 111.238 30.9122C109.852 30.0488 108.807 28.9354 108.102 27.5721C107.398 26.186 107.046 24.5955 107.046 22.8005C107.046 21.0054 107.318 19.4944 107.864 18.2675C108.432 17.0177 109.193 16.0862 110.147 15.4727C111.124 14.8592 112.204 14.5524 113.385 14.5524C114.839 14.5524 115.987 15.075 116.827 16.1202C117.691 17.1654 118.123 18.5969 118.123 20.4147C118.123 22.9822 117.566 25.8338 116.453 28.9695C117.611 29.174 118.975 29.2762 120.542 29.2762ZM110.488 22.5619C110.488 24.7886 111.204 26.436 112.635 27.5039C113.521 24.9591 113.965 22.8573 113.965 21.1986C113.965 20.2443 113.84 19.5512 113.59 19.1195C113.34 18.6651 112.999 18.4379 112.567 18.4379C111.954 18.4379 111.454 18.8014 111.067 19.5285C110.681 20.2329 110.488 21.244 110.488 22.5619ZM123.194 25.8679C122.24 25.8679 121.524 25.6521 121.047 25.2204C120.57 24.7659 120.331 24.1411 120.331 23.3458C120.331 22.5505 120.638 21.8916 121.251 21.369C121.888 20.8237 122.671 20.551 123.603 20.551C124.444 20.551 125.125 20.7555 125.648 21.1645C126.171 21.5735 126.432 22.1529 126.432 22.9027C126.432 23.8116 126.137 24.5387 125.546 25.084C124.955 25.6066 124.171 25.8679 123.194 25.8679ZM122.921 44.1704C121.444 44.1704 120.365 43.6478 119.683 42.6026C119.025 41.5574 118.695 40.1714 118.695 38.4445C118.695 37.422 118.82 36.1155 119.07 34.525C119.343 32.9117 119.683 31.4121 120.092 30.026C120.297 29.2989 120.57 28.7991 120.91 28.5264C121.251 28.2537 121.797 28.1174 122.546 28.1174C123.705 28.1174 124.285 28.5037 124.285 29.2762C124.285 29.8443 124.069 31.1621 123.637 33.2298C123.092 35.7292 122.819 37.422 122.819 38.3082C122.819 38.9898 122.91 39.5124 123.092 39.876C123.274 40.2395 123.58 40.4213 124.012 40.4213C124.421 40.4213 124.932 40.1373 125.546 39.5692C126.159 39.0012 126.977 38.1037 128 36.8767C128.272 36.5586 128.579 36.3995 128.92 36.3995C129.215 36.3995 129.443 36.5359 129.602 36.8085C129.783 37.0812 129.874 37.4561 129.874 37.9333C129.874 38.8421 129.658 39.5465 129.227 40.0464C126.977 42.7957 124.875 44.1704 122.921 44.1704ZM133.456 44.9202C132.275 44.9202 131.366 44.6476 130.73 44.1022C130.116 43.5569 129.809 42.9434 129.809 42.2618C129.809 41.671 130.025 41.1598 130.457 40.728C130.889 40.2963 131.525 40.0805 132.366 40.0805C132.661 40.0805 133.002 40.1146 133.388 40.1827C133.797 40.2282 134.104 40.2622 134.308 40.285C134.286 39.6942 134.149 39.1375 133.899 38.6149C133.672 38.0923 133.377 37.5924 133.013 37.1153C132.65 36.6154 132.309 36.1837 131.991 35.8201C131.286 37.1607 130.582 38.2741 129.877 39.1602C129.196 40.0464 128.446 40.8871 127.628 41.6824C127.219 42.0914 126.787 42.2959 126.333 42.2959C125.969 42.2959 125.674 42.1709 125.447 41.9209C125.219 41.6483 125.106 41.3188 125.106 40.9325C125.106 40.4781 125.265 40.0578 125.583 39.6715L126.026 39.1262C127.276 37.5811 128.219 36.3086 128.855 35.3089C129.241 34.6499 129.696 33.7751 130.218 32.6845C130.741 31.5711 131.252 30.4237 131.752 29.2421C132.184 28.2424 133.081 27.7425 134.445 27.7425C135.081 27.7425 135.524 27.7993 135.774 27.9129C136.024 28.0265 136.149 28.2083 136.149 28.4582C136.149 28.5946 136.103 28.8104 136.012 29.1058C135.921 29.4012 135.797 29.6966 135.637 29.992C135.228 30.8099 135.024 31.503 135.024 32.071C135.024 32.4118 135.138 32.7867 135.365 33.1957C135.615 33.6047 135.99 34.116 136.49 34.7295C137.217 35.6838 137.762 36.5018 138.126 37.1834C138.512 37.8424 138.705 38.5695 138.705 39.3647C138.705 39.592 138.682 39.9101 138.637 40.3191C139.75 39.8873 141.057 38.7399 142.556 36.8767C142.829 36.5586 143.136 36.3995 143.477 36.3995C143.772 36.3995 143.999 36.5359 144.158 36.8085C144.34 37.0812 144.431 37.4561 144.431 37.9333C144.431 38.7967 144.215 39.5011 143.783 40.0464C142.647 41.4551 141.557 42.4208 140.511 42.9434C139.489 43.4433 138.216 43.716 136.694 43.7614C135.785 44.534 134.706 44.9202 133.456 44.9202ZM153.727 28.1174C154.454 28.1174 155 28.3105 155.363 28.6968C155.749 29.0604 155.943 29.6057 155.943 30.3328C155.943 30.9235 155.818 32.0369 155.568 33.6729C155.34 35.0589 155.159 36.3768 155.022 37.6265C154.886 38.8535 154.818 40.2282 154.818 41.7505C154.818 42.614 154.636 43.2388 154.273 43.6251C153.932 43.9886 153.364 44.1704 152.568 44.1704C151.819 44.1704 151.273 43.9773 150.932 43.591C150.592 43.2047 150.421 42.6253 150.421 41.8528C150.421 40.9439 150.58 39.4443 150.898 37.3538C151.171 35.5361 151.307 34.3773 151.307 33.8774C151.307 33.5138 151.182 33.3321 150.932 33.3321C150.637 33.3321 150.217 33.7183 149.671 34.4909C149.126 35.2407 148.581 36.2405 148.035 37.4902C147.49 38.7399 147.047 40.0578 146.706 41.4438C146.456 42.5117 146.161 43.2388 145.82 43.6251C145.502 43.9886 144.991 44.1704 144.286 44.1704C143.582 44.1704 143.059 43.9205 142.718 43.4206C142.4 42.898 142.184 42.1027 142.071 41.0348C141.957 39.9669 141.9 38.3991 141.9 36.3314C141.9 32.8322 142.253 29.1853 142.957 25.3908C143.684 21.5962 144.741 18.4151 146.127 15.8476C147.535 13.2573 149.217 11.9621 151.171 11.9621C152.216 11.9621 153.057 12.4166 153.693 13.3254C154.352 14.2116 154.682 15.3704 154.682 16.8019C154.682 19.0968 154.011 21.4826 152.671 23.9593C151.33 26.4133 149.149 29.2876 146.127 32.5822C146.059 33.7638 146.024 34.9794 146.024 36.2291C146.774 34.2978 147.604 32.7299 148.513 31.5257C149.444 30.2987 150.353 29.4239 151.239 28.9013C152.148 28.3787 152.977 28.1174 153.727 28.1174ZM150.455 15.3363C150.046 15.3363 149.592 15.9271 149.092 17.1086C148.592 18.2675 148.104 19.8466 147.626 21.8462C147.172 23.823 146.797 25.9815 146.502 28.3219C147.91 26.6632 149.069 24.8568 149.978 22.9027C150.91 20.9486 151.375 19.1763 151.375 17.5858C151.375 16.8587 151.296 16.302 151.137 15.9157C150.978 15.5295 150.751 15.3363 150.455 15.3363Z" fill="white"/>
              </svg>
            </div>
          )}

          {/* Back button - 只在需要时显示，不会被logo挤压 */}
          {showBackButton && onBack && (
            <button
              onClick={onBack}
              className="p-3 rounded-full bg-white/10 backdrop-blur-sm hover:bg-white/20 transition-colors touch-manipulation"
            >
              <ArrowLeft className="w-5 h-5 sm:w-6 sm:h-6" />
            </button>
          )}
        </div>

        {/* Center - Empty space for better balance */}
        <div className="flex-1"></div>

        {/* Right side - Language switcher and Auth components */}
        <div className="flex items-center space-x-3">
          {/* Language switcher */}
          <LanguageSwitcher />

          {/* Auth section */}
          {loading ? (
            <div className="w-8 h-8 border-2 border-purple-400 border-t-transparent rounded-full animate-spin"></div>
          ) : user ? (
            <div className="flex items-center space-x-3">
              {/* User info */}
              <div className="hidden sm:flex items-center space-x-2 bg-white/10 backdrop-blur-sm rounded-full px-3 py-2">
                <User className="w-4 h-4 text-purple-400" />
                <span className="text-sm font-medium text-white max-w-32 truncate">
                  {user.user_metadata?.full_name || user.user_metadata?.name || user.email?.split('@')[0]}
                </span>
              </div>
              
              {/* Mobile user indicator */}
              <div className="sm:hidden w-8 h-8 bg-white/10 backdrop-blur-sm rounded-full flex items-center justify-center">
                <User className="w-4 h-4 text-purple-400" />
              </div>

              {/* Sign out button */}
              <button
                onClick={handleSignOut}
                className="p-2 bg-white/10 backdrop-blur-sm hover:bg-white/20 rounded-full transition-colors touch-manipulation"
                title={t('landing.signOut')}
              >
                <LogOut className="w-4 h-4" />
              </button>
            </div>
          ) : (
            /* Sign in button */
            <button
              onClick={handleSignIn}
              className="flex items-center space-x-2 bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 rounded-full px-4 py-2 transition-all touch-manipulation"
            >
              <LogIn className="w-4 h-4" />
              <span className="hidden sm:inline text-sm font-medium">{t('landing.signIn')}</span>
            </button>
          )}
        </div>
      </div>
    </header>
  );
};

export default Header;